---
title: "Garden Experiment Power Analysis"
output:
  html_document: default
    #df_print: paged
  pdf_document: default
---

# Introduction

To study the effects of biotic factors on early secondary successional plant community we decided to perform manipulative experiments using randomized complete block (RCB) design. For our data we assumed simple one-way classification with one random effect (random intercept model) of a following form:
$$\begin{matrix} \mathbb{E} [y_{ij}|a_j] = \mu + \beta_ix_{ij} + a_j + \varepsilon_{ij} \\ y_{ij}|a_j \sim indep.\ G\\ a_j \sim i.i.d.\ \mathcal{N}(0,\sigma_a^2) \end{matrix}$$
where, $y_{ij}$ represents community descriptor under treatement $i \in (1,..., 6)$, within block $j \in (1,..., 6)$, and where $G$ is a distribution for $y_{ij}|a_j$ with variance $\sigma^2_{\varepsilon}$.

Biomass, species richness and diversity are important drivers of plant community dynamics (Lohbeck, Poorter,..., Bongers; 2015) In order to calculate number of samples, in this case number of blocks each containing complete set of six experimental treatments (see the main text for details), we used parameter values reported in the literature, or based on our own experience. From the model equation we can see that for any community descriptor we need three estimates: baseline value $\mu$; within block (local) variation $\sigma^2_{\varepsilon}$); between block (regional) variation $\sigma^2_{a}$. Therefore for plant total above ground biomass, species richness, and abundance we assumed values of 9 parameters.

*As mentioned in the main text we anticipated a strong increase in biomass, richness and species diversity for the insecticide treated plots and equally strong decrease in these characteristics when high number of herbivores added to the plot. Predator exclosure should have moderate effect on the community as well as intermediate levels of herbivory addition. However, we suspect, that the effect of moderate herbivor addition should be weaker than that of the high herbivory addition but stronger than that of predators. We did not expect fungi to have strong effect on the biomass but rather on the abundance and species richness.*

For the purposes of our exploratory analyses we focused on considerably strong effects of approximately 15% change for the mean under given treatment. With a specified effect size we were able to estimate the number of blocks optimal to obtain 80% statistical power. We also explored how different levels of variation between blocks and residual variation affect power of our tests. We also explore how power would change in resonse to changing values of our assumed parameters. Power calcuations were performed using the *simr* package (Green and MacLeod, 2016) in R.

# Biomass

## Estimates of variation

There are not many accurate estimations of total above-ground biomass for one year old tropical forest succession. Often data available in the literature depend highly on the previous land use. In their revview Martin et al. (2013) we found estimate for TAGB to be equal to $\sim$ 14 $Mg * ha^{-1}$. However, these values are more representative to vegetation undergoing secondary succession after pasture abandonment, thatn to forest gaps within forest matrix. In different estimation Mascaro et al (2005) found that after one year of regeneration after hurrican distrurbce biomass ranged largly with mean 78 $\pm$ 15 $Mg * ha^{-1}$. From our personal experience we new that these estimates were either too low or too high. Second study provided us also with estimates of variation. However, we treated this as an upper limit for variation since this type of disturbance creates a variable initial environment for regenration. In our setup we didn't expect such a high variability as we prepared plots in similar fassion trying to minimise differences caused by gap creation. Therefore we confidently assumed that in our 25 m$^2$ plots we would found approximately 100 kg of plant biomass with both $\sigma_{a}$ and $\sigma_{\varepsilon}$ of around 10 kg.

```{r setup, include=TRUE, echo=F, fig.height=4, fig.width=4, align="center"}

# Estimates
# tagb <- 100
# mu=log(tagb)
# sigma2 = 0.0054
# # sdg = sqrt(sigma2)
# sd = sqrt(sigma2)

set.seed(1234)

tagb <- 100
mu=log(tagb)
# sigma2 = 0.0381 # sd = 20
sigma2 = 0.01   # sd = 10
sd = sqrt(sigma2)

# Histogram of biomasses
vals2 <- rlnorm(100000, mu, sd) # inputs are the mu and sd of the noorm vals
hist(vals2, breaks=100, probability=T)
```

Fig.1 B) Histogram of the logged biomass values (in kilograms) of a log-normal distribution with $\mu$ = `r tagb` kg, and $\sigma_{\varepsilon}$ = 10 kg.

*For a 25 m$^2$ plot, this gives approximately TAGB. Unfortunately, we were not able to find any explicit estimates of variation for TAGB of a one year old successional vegetation. However, study mentioned TAGB for secondary forests averaging at 46.4 $\pm$ 4.3 T/ha (standard deviation). Based on simple proportional relationship we estimate that early successional plots might have $\sigma_{\varepsilon}\sim$ 10 kg. Because we assume that the biomass values follow log-normal distribution estimated that for the loged values of biomas $\sigma^2_{block}$ would be around 0.0054 (Fig.1 B).*

## Randomization

With the estimates for $\mu$, $\sigma^2_{a}$, $\sigma^2_{\varepsilon}$ and selected effect size we can now create a hypothetical dataset with an arbitrary number of blocks each having 6 experimental treatment (including control) and examine sample size necessary to obtain 80% statistical power.

```{r, echo=F, warning=FALSE, message=F, align = "center", fig.show='hold',  fig.height=3, fig.width=5}
# pattern <- c(int,fung,h1,h2,ins,pred)

mu = 95
mcrands <- 99
sdg = sqrt(sigma2)
sd = sqrt(sigma2)
eff_size = 10
leff_size = log((mu + eff_size)/mu)

library(simr)
library(ggplot2)

# Create dataset
treat <- c("c","f","h1","h2","i","p")
gard <- LETTERS[1:20]

dat <- expand.grid(gard=gard, treat = treat)

bioexp <- makeLmer(y~treat+(1|gard),
                     fixef = c(log(95),                    # control
                               0,                          # fungi
                               -(leff_size/2+leff_size)/2, # herb moderate
                               -leff_size,                 # herbivory high
                               leff_size,                  # insecticide
                               -leff_size/2),              # predator
                     VarCorr = 0.01,
                     sigma = sqrt(0.01),
                     data=dat)


dt <- getData(bioexp)

# Plot hypothetical dataset
plt <- ggplot(dt, aes(x = treat, y = y))
plt + geom_jitter(width = 0.2, size=2, alpha=0.5) +
  theme_bw() +
  ylab("Biomass [kg]") +
  xlab("Treatment")
  
pc2 <- powerCurve(bioexp, along = "gard", breaks=c(3,4,5,6,7,8,9,10,11,12), 
                  nsim=mcrands, progress = F)
plot(pc2)
```

Fig 3. A) An example dataset generated using log-normal mean `r mu`, between-block standard deviation $\sqrt{\sigma_{block}} =$ `r round(sqrt((exp(sdg^2)-1)*exp(2*log(mu) + sdg^2)),2)`and within-block standard deviation $\sqrt{\sigma_{error}}=$ `r round(sqrt((exp(sd^2)-1)*exp(2*log(mu) + sd^2)),2)`. Effect size of `r eff_size` kg. Simulated datasets with six treatments grouped in 20 blocks and a hypothetical effect size of - `r eff_size` for high herbivory (h2), `r 0.5 * eff_size` for predator removal and `r eff_size` for insecticide treatment. B) Power curve with confidence intervals for the power estimates based on `r mcrands` randomizations.

From this analysis we conclude that for the above assumptions we have 80% probability of detecting existing effects already with six experimental blocks.

# Species richness and woody plant abundance

## Estimates of variation

We expected to find approximately 30 $\pm$ 5 plant species (herbaceous and woody plants) per plot (Leps, personal communication). It is difficult to estimates for the abundance of stems having DBH greater of equal to 1cm (Ohtsuka Biomass changes in early tropical succession..). However, based on Whitfeld et al. (2012) and from our experience we expected to have (similarily to the number of species) approximately 30 $\pm$ 5 stems per 25m$^2$ experimental plot. We assumed Poisson distribution for the number of species and number of stems. 

## Randomization

As above we created random dataset for for number of species and abundance of stems $\leq$ 1 cm DBH, and explore number of blocks necessary to detect 5 species/5 stems shift in average values at the 80% statistical power.

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.show='hold'}
mu = 30
mcrands <- 99
sdg = 5
sd = 5
eff_size = -5
leff_size = log((mu + eff_size)/mu)

# Create dataset
treat <- c("c","f","h1","h2","i","p")
gard <- LETTERS[1:20]

dat <- expand.grid(gard=gard, treat = treat)

richexp <- makeGlmer(y~treat+(1|gard),
                    family = "poisson",
                    fixef = c(log(mu),0,0,
                              leff_size,-leff_size,-leff_size/2), 
                    VarCorr = 0.0225, # estimated such that s_e is ~ 5.
                    data=dat)

dt <- getData(richexp)

par(mfrow=c(1,2))
plt <- ggplot(dt, aes(x = treat, y = y, colour = gard))
plt + geom_jitter(width = 0.2, size=2, alpha=0.5) +
  theme_bw() +
  ylab("Species richness") + 
  xlab("Treatment")

pc2 <- powerCurve(richexp, along = "gard", breaks=c(3,4,5,6,7,8,9,10,11,12), 
                  nsim=mcrands, progress = F)
plot(pc2)

```

Fig X. ...

# Sample  size, within-block and between-block variation

Here we want do analyze sensitivity of our estimates on the expected power of our analyses. We perform a randomization manipulating three parameters: number of samples, between block variation and within block noise (within block variation) 

```{r}
# mcrands <- 999
# wbsd <- round(sqrt(seq(0.0005, 0.01, by = 0.0025)),3)
# bbsd <- round(sqrt(seq(0.0005, 0.01, by = 0.0025)),3)
# ssize <- seq(5, 20, by=1)#sample size
# # leff_size varry the effect size? 
# # Random effect standard deviation
# resmatgard1 <- matrix(0, 
#                       nrow = length(wbsd),
#                       ncol = length(ssize))
# rownames(resmatgard1) <- as.character(round(wbsd, 3))
# colnames(resmatgard1) <- ssize
# 
# for(row in wbsd){
#   for(col in ssize){
#     temp_res <- randDat(rands=mcrands,
#                     pattern=c(1,0,0,leff_size,0,0),
#                     mu=log(mu),
#                     sdg = row,
#                     sd = sd,
#                     ngard = col,
#                     nplot = 6)
#     rd <- temp_res$fits
#     p_hat <- sum(rd/mcrands)
#     
#     resmatgard1[as.character(row),as.character(col)] <- p_hat
#     
#   }
# }
# 
# levelplot(resmatgard1, xlab = "Between block variation",
#           ylab = "Number of blocks") +
#   as.layer(contourplot(resmatgard1, col = "red"))
# 
# 
# # With simr
# vars <- seq(0.003, 0.090, by=0.015)
# resmatgard1 <- matrix(0, 
#                       nrow = length(vars),
#                       ncol = length(vars))
# rownames(resmatgard1) <- as.character(round(vars, 3))
# colnames(resmatgard1) <- as.character(round(vars, 3))
# 
# mcrands <- 99
# counter <- 1
# dims    <- length(vars)
# for (i in vars){
#   for(j in vars){
#     counter <- counter + 1
#     print(counter/(dims*dims))
#     VarCorr(bio_rbl) <- i  #
#     sigma(bio_rbl) <- sqrt(j)
#     est <- powerSim(bio_rbl, nsim = mcrands)
#     resmatgard1[as.character(i),
#                 as.character(j)] <- summary(est)$mean
#   }
# }
# 
# levelplot(resmatgard1, ylab = "Sigma",
#           xlab = "VarCorr")

```

# Literature

Green P, MacLeod CJ (2016). “simr: an R package for power analysis
of generalised linear mixed models by simulation.” _Methods in
Ecology and Evolution_, *7*(4), 493-498. doi:
10.1111/2041-210X.12504