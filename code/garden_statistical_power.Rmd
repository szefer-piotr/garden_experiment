---
title: "Garden Experiment Power Analysis"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

# Introduction

To study the effects of biotic factors on early secondary successional plant community we decided to perform manipulative experiments using randomized complete block (RCB) design. For our data we assumed simple one-way classification with one random effect (random intercept model) of the following form:
$$\begin{matrix} \mathbb{E} [y_{ij}|a_j] = \mu + \beta_ix_{ij} + a_j + \varepsilon_{ij} \\ y_{ij}|a_j \sim indep.\ G\\ a_j \sim i.i.d.\ \mathcal{N}(0,\sigma_a^2) \end{matrix}$$
where, $y_{ij}$ represents community descriptor under treatement $i$, within block $j$, and where $G$ is a distribution for $y_{ij}|a_j$ with variance $\sigma^2_{\varepsilon}$.

Biomass, species richness and diversity are important drivers of tropical plant community dynamics (Lohbeck, Poorter, Mart√≠nez-Ramos, and Bongers, 2015). In order to calculate number of samples (in this case number of blocks each containing complete set of six experimental treatments - see the main text for details), we used parameter values found in the literature, or based on our own experience. Model equation suggests that for any community descriptor in oreder to create a hypothetical data set we need to guess three parameter values for baseline average value $\mu$, within block (local) variation $\sigma^2_{\varepsilon}$),and between block (regional) variation $\sigma^2_{a}$. Therefore, for the total above ground biomass (TAGB) of plants, species richness, and abundance we need to assume values for 9 parameters.

To perform power analysis we also need to declare magnitudes of the effect for each of our experimental treatemnt. As mentioned in the main text we anticipated a strong increase in biomass, richness and species diversity for the insecticide treated plots, and equally strong decrease in these community characteristics when high number of herbivores added to the plot. We expected predator exclosure to have moderate negative effect on the community as well as intermediate levels of herbivory addition. However, we suspect, that the effect of moderate herbivor addition should be weaker than that of the high herbivory addition but stronger than that of predators. We did not expect fungi to have strong effect on the biomass but rather on the abundance and species richness. Here by strong effects we mean shift in the baseline value of the descriptor of approximately 15% under given treatment. Having all the above assumptions in check we were able to estimate the number of blocks optimal to obtain 80% statistical power. We also explored how different levels of variation between blocks and residual variation affect power of our tests. We also explore how power would change in resonse to changing values of our assumed parameters. Power calcuations were performed using the *simr* package (Green and MacLeod, 2016) in R.

# Biomass

## Estimates of variation

Estimates of the total plant above-ground biomass (TAGB) for one year old tropical forest successional communities are scarce in the literature and some functional respoonces fitted to  available data may inaccurately predict TAGB for younger plant communities (Sierra et al 2007). From a comprehensive review by Martin, Newton, and Bullock (2013) from 607 secondary forest sites we were able to extract only two estimates of TAGB for plant community after one year of regeneration since abandonment. TAGB for these two plots averaged at $\sim$ 12 Mg $\times$ ha $^{-1}$ (which gives `r 12 * 1000 * 0.0025` kg $\times$ 25 m$^{2}$ for experimental plot used in our study). However, source studies were restricted only to secondary succession after pasture abandonment, which may negatively affect initial biomass accumulation rates. Different study of gap succession following hurricane disturbance in wet tropical forest by Mascaro et al. (2005) showed that after one year after disturbance TAGB averaged at 78 $\pm$ 15 Mg $\times$ ha $^{-1}$ (`r 78 * 1000 * 0.0025` kg $\times$ 25 m$^{2}$). In tropical forest regeneration following small slash-and-burn cultivation we expected TAGB in primary forest matrix to result in higher values than during spontaneous succession in pastures. At the same time we believe it should be lower than in naturally created gaps. Moreover, by design we tried to minimise unpredicted differences in initial conditions for regeneration, which should keep the variation between and within blocks small. Therefore for the theoretical distribution of plant biomass in a 25 m$^2$ plots we safely assumed log-normal distribution with $\mu$ = 100 kg and $\sigma_{a}$ = $\sigma_{\varepsilon}$ = 10 kg (Fig.1).

```{r setup, include=TRUE, echo=F, fig.height=4, fig.width=4, align="center"}
# Estimates
# tagb <- 100
# mu=log(tagb)
# sigma2 = 0.0054
# # sdg = sqrt(sigma2)
# sd = sqrt(sigma2)

set.seed(1234)

tagb <- 100
mu=log(tagb)
# sigma2 = 0.0381 # sd = 20
sigma2 = 0.0099   # sd = 10
sd = sqrt(sigma2)

sdlognorm <- sqrt((exp(sigma2) -1)*exp(2*mu + sigma2))

# Histogram of biomasses
vals2 <- rlnorm(1000000, mu, sd) # inputs are the mu and sd of the noorm vals
hist(vals2, breaks=100, probability=T, col = "black", xlab = "Total above-ground plant biomass [kg]")
```

Figure 1. Histogram of the expected total above-ground biomass values for a one year old successional plant community at a 25 m$^2$ experimental plot (in kilograms). Values generated from a log-normal distribution with $\mu$ = `r tagb` kg, and $\sigma_{\varepsilon}$ = `r round(sdlognorm,1)` kg.

## Randomization

With the estimates for $\mu$, $\sigma^2_{a}$, $\sigma^2_{\varepsilon}$ and selected effect size we can now create a hypothetical dataset with an arbitrary number of blocks each having 6 experimental treatment (including control) and examine sample size necessary to obtain 80% statistical power.

```{r, echo=F, warning=FALSE, message=F, align = "center", fig.show='hold'}
# pattern <- c(int,fung,h1,h2,ins,pred)

mu = tagb
mcrands <- 99
sdg = sqrt(sigma2)
sd = sqrt(sigma2)
eff_size = 10
leff_size = log((mu + eff_size)/mu)

library(simr)
library(ggplot2)
library(latticeExtra)

# Create dataset
treat <- c("c","f","h1","h2","i","p")
gard <- LETTERS[1:20]

dat <- expand.grid(gard=gard, treat = treat)

bioexp <- makeLmer(y~treat+(1|gard),
                     fixef = c(log(95),                    # control
                               0,                          # fungi
                               -(leff_size/2+leff_size)/2, # herb moderate
                               -leff_size,                 # herbivory high
                               leff_size,                  # insecticide
                               -leff_size/2),              # predator
                     VarCorr = 0.01,
                     sigma = sqrt(0.01),
                     data=dat)


dt <- getData(bioexp)

# Plot hypothetical dataset
plt <- ggplot(dt, aes(x = treat, y = y))
plt + geom_jitter(width = 0.2, size=2, alpha=0.5) +
  theme_bw() +
  ylab("Biomass [kg]") +
  xlab("Treatment")
  
pc2 <- powerCurve(bioexp, along = "gard", breaks=c(3,4,5,6,7,8,9,10,11,12), 
                  nsim=mcrands, progress = F)
plot(pc2)
```

Fig 3. A) An example dataset generated using log-normal mean `r mu`, between-block standard deviation $\sqrt{\sigma_{block}} =$ `r round(sqrt((exp(sdg^2)-1)*exp(2*log(mu) + sdg^2)),2)`and within-block standard deviation $\sqrt{\sigma_{error}}=$ `r round(sqrt((exp(sd^2)-1)*exp(2*log(mu) + sd^2)),2)`. Effect size of `r eff_size` kg. Simulated datasets with six treatments grouped in 20 blocks and a hypothetical effect size of - `r eff_size` for high herbivory (h2), `r 0.5 * eff_size` for predator removal and `r eff_size` for insecticide treatment. B) Power curve with confidence intervals for the power estimates based on `r mcrands` randomizations.

From this analysis we conclude that for the above assumptions we have 80% probability of detecting existing effects already with six experimental blocks.

# Species richness and woody plant abundance

## Estimates of variation

We expected to find approximately 30 $\pm$ 5 plant species (herbaceous and woody plants) per plot (Leps, personal communication). It is difficult to estimates for the abundance of stems having DBH greater of equal to 1cm (Ohtsuka Biomass changes in early tropical succession..). Based on Whitfeld et al. (2012) and from our experience we expected to have (similarily to the number of species) approximately 30 $\pm$ 5 stems per 25m$^2$ experimental plot. We assumed Poisson distribution for the number of species and number of stems. 

## Randomization

As above we created random dataset for for number of species and abundance of stems $\leq$ 1 cm DBH, and explore number of blocks necessary to detect 5 species/5 stems shift in average values at the 80% statistical power.

```{r,echo=FALSE, warning=FALSE, message=FALSE, fig.show='hold'}
mu = 30
sdg = 6
sd = 6
eff_size = 6
leff_size = log((mu + eff_size)/mu)

# Create dataset
treat <- c("c","f","h1","h2","i","p")
gard <- LETTERS[1:20]

dat <- expand.grid(gard=gard, treat = treat)

richexp <- makeGlmer(y~treat+(1|gard),
                    family = "poisson",
                    fixef = c(log(mu),                    # control
                               -leff_size,                # fungi
                               (leff_size/2+leff_size)/2, # herb moderate
                               leff_size,                 # herbivory high
                               -leff_size,                # insecticide
                               leff_size/2),              # predator, 
                    VarCorr = 0.225, # estimated such that s_e is ~ 5. 0.0225
                    data=dat)

dt <- getData(richexp)

par(mfrow=c(1,2))
plt <- ggplot(dt, aes(x = treat, y = y, colour = gard))
plt + geom_jitter(width = 0.2, size=2, alpha=0.5) +
  theme_bw() +
  ylab("Species richness") + 
  xlab("Treatment")

pc2 <- powerCurve(richexp, along = "gard", breaks=c(3,4,5,6,7,8,9,10,11,12), 
                  nsim=mcrands, progress = F)
plot(pc2)

```

Fig X. ...

# Sample  size, within-block and between-block variation

At the last step we analyze sensitivity of the expected power to the variance of our variance estimates. For the TAGB for within blocks variation any value below 15 kg ensures acceptable power of out tests. For the richness and abundance the asumptions of the Poisson distribution indicates that the variance at the plot is equal to the average number of species/stems. Therefore, between block variation should not affect it much. We pthese should not be affected by changes in between block variation. 

```{r, echo=F, warning=F, message=F, fig.show='hold'}

# levelplot(resmatgard1, xlab = "Between block variation",
#           ylab = "Number of blocks") +
#   as.layer(contourplot(resmatgard1, col = "red"))

vars <- round(seq(0.0005, 0.045, by=0.005), 4) #sd's
resmatgard1 <- matrix(0, 
                      nrow = length(vars),
                      ncol = length(vars))
rownames(resmatgard1) <- as.character(round(vars, 4))
colnames(resmatgard1) <- as.character(round(vars, 4))


mod <- bioexp
mcrands <- 9

dims    <- length(vars)
for (i in vars){
  for(j in vars){
    VarCorr(mod) <- i  #
    sigma(mod) <- sqrt(j)
    est <- powerSim(mod, nsim = mcrands, progress = F)
    resmatgard1[as.character(i),
                as.character(j)] <- summary(est)$mean
  }
}

# Rename rows and columns
newnames <- c()
for(value in vars){
  vals <- rlnorm(10000, log(95), sqrt(value))
  newnames <- c(newnames, sd(vals))
}

newnames <- round(newnames, 0)
rownames(resmatgard1) <- as.character(newnames)
colnames(resmatgard1) <- as.character(newnames)

levelplot(resmatgard1, ylab = "Within block variation (Sigma)",
          xlab = "Between block variation (VarCorr)") +
  as.layer(contourplot(resmatgard1, col = "red"))

# Repeat for the Poisson models. It will depend on the error in the mean estiamations
mus <- seq(2,10,by=1)

respois <- data.frame()
for(mu in mus){
  print(mu)
  fixef(richexp) = c(log(mu),                    # control
            -leff_size,                # fungi
            (leff_size/2+leff_size)/2, # herb moderate
            leff_size,                 # herbivory high
            -leff_size,                # insecticide
            leff_size/2)
  est <- powerSim(richexp, nsim = mcrands, progress = F)
  rowrand <- data.frame(mu = mu, 
                        lower=summary(est)$lower,
                        mean = summary(est)$mean,
                        upper = summary(est)$upper)
  respois <- rbind(respois,rowrand)
}

pplot <- ggplot(respois, aes(x = mu, y = mean))
pplot + geom_pointrange(data=respois, 
                mapping=aes(x=mu, y=mean, ymin=lower, ymax=upper), 
                width=0.2, size=1, color="blue", fill="white") +
  geom_hline(yintercept = 0.8)

```

# Literature

Green P, MacLeod CJ (2016). ‚Äúsimr: an R package for power analysis
of generalised linear mixed models by simulation.‚Äù _Methods in
Ecology and Evolution_, *7*(4), 493-498. doi:
10.1111/2041-210X.12504

Lohbeck, M., Poorter, L., Mart√≠nez-Ramos, M., & Bongers, F. (2015). Biomass is the main driver of changes in ecosystem process rates during tropical forest succession. Ecology, 96(5), 1242‚Äì1252. doi: 10.1890/14-0472.1

Martin, P. A., Newton, A. C., & Bullock, J. M. (2013). Carbon pools recover more quickly than plant biodiversity in tropical secondary forests. Proceedings of the Royal Society B: Biological Sciences. Retrieved from https://royalsocietypublishing.org/doi/abs/10.1098/rspb.2013.2236

Mascaro, J., Perfecto, I., Barros, O., Boucher, D. H., Cerda, I. G. D. L., Ruiz, J., & Vandermeer, J. (2005). Aboveground Biomass Accumulation in a Tropical Wet Forest in Nicaragua Following a Catastrophic Hurricane Disturbance. Biotropica, 37(4), 600‚Äì608. doi: 10.1111/j.1744-7429.2005.00077.x

Whitfeld et al. (2012)
